<%
  const u = (typeof currentUser !== 'undefined' && currentUser) ? currentUser : null;
  const _path = (typeof path !== 'undefined' && path) ? path : '/';

  // اجمع صلاحيات الأدوار (لروابط الأدمن فقط)
  const allPerms = new Set();
  (u?.userRoles || []).forEach(ur =>
    (ur.role?.permissions || []).forEach(rp => rp.permission?.name && allPerms.add(rp.permission.name))
  );
  const isAdminLike = allPerms.has('create_role') || allPerms.has('admin_panel');

  const displayName = u ? (u.name || u.email) : '';
%>

<header class="shell">
  <div class="navbar" style="display:flex;align-items:center;gap:12px;justify-content:space-between">
    <!-- Left: brand + main nav -->
    <div style="display:flex;align-items:center;gap:16px">
      <div class="brand">
        <a href="/">PM Platform</a>
        <span class="badge">beta</span>
      </div>
      <nav class="nav" style="display:flex;gap:10px">
        <a class="<%= (_path==='/')?'active':'' %>" href="/">Home</a>
        <% if (u) { %>
          <a class="<%= (_path.startsWith('/dashboard'))?'active':'' %>" href="/dashboard">Dashboard</a>
          <% if (isAdminLike) { %>
            <a class="<%= (_path.startsWith('/admin/features'))?'active':'' %>" href="/admin/features">Features</a>
            <a class="<%= (_path.startsWith('/assignable'))?'active':'' %>" href="/assignable">Assignable</a>
          <% } %>
        <% } else { %>
          <a class="<%= (_path==='/login')?'active':'' %>" href="/login">Login</a>
        <% } %>
      </nav>
    </div>

    <!-- Right: user name + logout -->
    <div style="display:flex;align-items:center;gap:12px">
      <% if (u) { %>
        <span style="color:#e2e8f0;font-size:14px;opacity:.9">Hello, <strong><%= displayName %></strong></span>
        <a class="btn btn-xs btn-outline" href="/logout">Logout</a>
      <% } %>
    </div>
  </div>
</header>
