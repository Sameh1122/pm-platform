<!DOCTYPE html>
<html>
<head>
  <title>Configure Approval — <%= project.name %></title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .doc-card{border:1px solid var(--border); background:var(--panel); border-radius:12px; padding:16px; margin-bottom:14px}
    .muted{color:var(--muted); font-size:13px}
    .small{font-size:12px; color:var(--muted)}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .steps-table{width:100%; border-collapse:collapse}
    .steps-table th,.steps-table td{border:1px solid var(--border); padding:8px}
    .steps-table th{background:var(--card)}
  </style>
</head>
<body>
  <%- include('partials/header') %>
  <%- include('partials/dashbar', { user }) %>

  <div class="container" style="max-width:1000px;">
    <div class="header">
      <h1>Configure Approval Cycle • <%= project.name %></h1>
      <div class="row">
        <a class="btn btn-outline" href="/projects/<%= project.id %>/preinit">Back to Pre-Initiation</a>
      </div>
    </div>

    <form method="POST" action="/projects/<%= project.id %>/approvals/save">
      <% documents.forEach(function(doc){ %>
        <div class="doc-card">
          <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0"><%= doc.type %></h3>
            <span class="small">
              Owner: <%= (doc.owner && (doc.owner.name || doc.owner.email)) || '-' %>
              • Status: <span class="status <%= doc.status %>"><%= doc.status %></span>
            </span>
          </div>

          <table class="steps-table" style="margin-top:10px;">
            <thead>
              <tr>
                <th style="width:90px;">Step #</th>
                <th>Approver Role</th>
              </tr>
            </thead>
            <tbody>
              <% if (doc.approvals && doc.approvals.length > 0) { %>
                <% doc.approvals.forEach(function(s, idx){ %>
                  <tr>
                    <td><%= idx + 1 %></td>
                    <td>
                      <select class="input" name="steps[<%= doc.id %>][]" required>
                        <option value="">-- Select Role --</option>
                        <% roles.forEach(function(r){ 
                             var selected = ('' + r.id) === ('' + s.roleId) ? 'selected="selected"' : '';
                        %>
                          <option value="<%= r.id %>" <%= selected %>><%= r.name %></option>
                        <% }); %>
                      </select>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td>1</td>
                  <td>
                    <select class="input" name="steps[<%= doc.id %>][]" required>
                      <option value="">-- Select Role --</option>
                      <% roles.forEach(function(r){ %>
                        <option value="<%= r.id %>"><%= r.name %></option>
                      <% }); %>
                    </select>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>

          <p class="muted" style="margin-top:8px;">
            لإضافة خطوات أكتر، احفظ الأول وارجع زوّد صف جديد (هنفعل إضافة ديناميكية لاحقاً).
          </p>
        </div>
      <% }); %>

      <div class="row" style="margin-top:12px;">
        <button class="btn" type="submit">Save Cycles</button>
        <a class="btn btn-outline" href="/projects/<%= project.id %>/preinit">Cancel</a>
      </div>
    </form>
  </div>
</body>
</html>
